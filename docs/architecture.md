# Архитектура проекта dlg-ngind

## Обзор

dlg-ngind - это платформа для создания диалоговых систем с использованием графовой структуры данных и подхода Domain-Driven Design (DDD).

## Структура проекта

```
dlg-ngind/
├── packages/
│   ├── graphya/           # Основной пакет для работы с графами диалогов
│   │   ├── examples/       # Примеры реализации диалогов
│   │   ├── lib/            # Вспомогательные библиотеки
│   │   └── tests/          # Тесты
│   └── sotajs/            # Фреймворк SotaJS (Domain-First Development)
└── docs/                  # Документация проекта
```

## Основные компоненты

### 1. GraphYa (Графовая система)

GraphYa предоставляет инфраструктуру для создания и управления графами диалогов:

- **EdgeAggregate**: Базовый агрегат для создания связей между узлами
- **Node**: Узлы графа, представляющие элементы диалога
- **Semantic Graph**: Семантическая система координат для информации

### 2. SotaJS (Фреймворк)

SotaJS - это фреймворк для разработки с фокусом на доменной логике:

- **Aggregates**: Богатые доменные модели с инкапсулированной бизнес-логикой
- **Use Cases**: Функциональные оркестраторы для координации между моделями и внешними сервисами
- **Ports & Adapters**: Явная система внедрения зависимостей через хуки

## Архитектурные принципы

### 1. Domain-First подход

Вся архитектура построена вокруг доменной логики:

1. **Моделирование домена**: Создание богатых агрегатов, инкапсулирующих бизнес-правила
2. **Use Cases**: Функции, orchestrating взаимодействие между доменными моделями и внешними сервисами
3. **Тестирование в изоляции**: Возможность тестирования всей бизнес-логики без инфраструктуры
4. **Реализация адаптеров**: Подключение реальной инфраструктуры (БД, API) на последнем этапе

### 2. Графовая структура данных

Все элементы диалоговой системы представлены в виде графа:

- **Узлы**: Интенты, состояния, диалоги
- **Ребра**: Переходы, связи, семантические отношения
- **Семантическая адресация**: Возможность находить информацию по идентификаторам узлов и связей

### 3. Типобезопасность

Весь код написан с использованием TypeScript с максимальной типизацией:

- **Generic типы**: Для создания специализированных версий агрегатов
- **Zod схемы**: Для валидации данных на границах системы
- **Branded Types**: Для безопасной работы с идентификаторами

## Поток данных

1. **Входящее сообщение**: Пользователь отправляет сообщение системе
2. **NLU обработка**: Сообщение обрабатывается для определения интента
3. **Поиск диалога**: Система находит соответствующий диалог по идентификатору
4. **Активация диалога**: Если диалог не активен, он активируется
5. **Определение интента**: Система определяет интент на основе NLU результатов
6. **Заполнение слотов**: Сбор необходимых параметров для интента
7. **Переход состояния**: Система переходит в следующее состояние на основе текущего состояния и интента
8. **Выполнение действий**: Выполняются соответствующие действия (вызов API, обновление данных и т.д.)
9. **Генерация ответа**: Система формирует ответ для пользователя
10. **Сохранение состояния**: Состояние диалога сохраняется для следующего взаимодействия

## Тестирование

Каждый агрегат имеет полный набор тестов:

- **Unit тесты**: Проверка создания агрегатов с валидными и невалидными данными
- **Тесты действий**: Проверка корректности выполнения действий агрегатов
- **Интеграционные тесты**: Проверка взаимодействия между агрегатами
- **Тесты Use Cases**: Проверка оркестрации бизнес-логики

## Расширяемость

Система спроектирована для легкого расширения:

1. **Новые типы агрегатов**: Можно создавать специализированные агрегаты для новых доменных сущностей
2. **Новые паттерны переходов**: Поддерживаются различные паттерны переходов между состояниями
3. **Новые каналы связи**: Легко добавлять новые каналы для взаимодействия с пользователями
4. **Новые обработчики**: Можно добавлять новые обработчики для интентов

## Производительность

1. **Ленивая загрузка**: Только необходимые части графа загружаются в память
2. **Кэширование**: Часто используемые элементы кэшируются для ускорения доступа
3. **Оптимизация переходов**: Алгоритмы оптимизированы для быстрого поиска переходов
4. **Параллельная обработка**: Поддерживается параллельная обработка нескольких диалогов

## Безопасность

1. **Валидация данных**: Все данные валидируются на границах системы
2. **Изоляция диалогов**: Каждый диалог изолирован от других
3. **Контроль доступа**: Возможность настройки прав доступа к диалогам
4. **Логирование**: Полное логирование всех операций для аудита