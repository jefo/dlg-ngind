# Карта Контекстов (Context Map)

Этот документ описывает взаимосвязи между ключевыми Ограниченными Контекстами (Bounded Contexts) системы на языке бизнеса.

## Бизнес-метафора: Операционная Система и Приложения

Чтобы понять архитектуру, представим себе смартфон. У него есть операционная система, которая управляет базовыми функциями, и приложения, которые решают конкретные задачи пользователя.

---

### 1. Контекст: `@chat` — Сервис Чата (Headless Messenger)

**Роль в метафоре: Операционная система для обмена сообщениями.**

Этот контекст представляет собой полноценное, но "безголовое" (headless) приложение-мессенджер. Каждый его запущенный экземпляр настраивается на работу с **одним конкретным транспортным каналом** (например, один инстанс для Telegram, другой для Slack).

**Обязанности:**
- **Управление каналом**: Адаптер транспорта (driving adapter) подключается к API внешней платформы (например, Telegram) и слушает входящие сообщения.
- **Моделирование диалога**: Ядро контекста оперирует доменными сущностями: `Chat` (комната чата), `Persona` (участник) и `Message` (сообщение).
- **Оркестрация**: При получении сообщения, ядро `chat` выполняет базовые операции: сохраняет сообщение, создает пользователя (`Persona`) и чат (`Chat`), если их еще нет.
- **Делегирование логики ответа**: Чтобы сгенерировать осмысленный ответ, `@chat` обращается к внешнему сервису или библиотеке, передавая ему контекст диалога.

**На языке бизнеса**: это **платформа для создания чат-сервисов**. Она предоставляет всю необходимую инфраструктуру для общения в одном канале, позволяя подключать к ней различные бизнес-логики.

---

### 2. Контекст: `@bot-persona` — Движок Диалоговой Логики

**Роль в метафоре: Специализированное приложение "Чат-Бот".**

Этот контекст является подключаемым "мозгом". Он не может работать сам по себе, а предоставляет свои услуги другим системам, таким как `@chat`.

**Обязанности:**
- **Ведение состояния диалога**: Для каждого чата (`conversationId`) он хранит его текущее состояние в рамках сценария (FSM).
- **Обработка ввода**: Получив от `@chat` сообщение пользователя, он определяет, какому событию в сценарии оно соответствует.
- **Генерация ответа**: На основе сценария, он формирует следующий ответ, который нужно отправить пользователю, и возвращает его обратно в `@chat`.

**На языке бизнеса**: это **конструктор логики ботов**. Он позволяет бизнес-аналитикам и разработчикам проектировать сложные, интерактивные сценарии общения, которые затем могут быть исполнены на любой чат-платформе.

---

## Схема взаимодействия

```
      Клиент (User)
           ^
           | (сообщение)
           v
+---------------------------------+
|  Инстанс @chat для Telegram     |
| (ОС для сообщений)              |
|---------------------------------|
| 1. Адаптер получает сообщение   |
| 2. Ядро создает/обновляет Chat, |
|    Persona, Message             |
| 3. Ядро ДЕЛЕГИРУЕТ получение    |
|    ответа движку @bot-persona   |
|          |                      |
|          +--------------------->|
|          |                      |
|          | (запрос: "Что ответить?")|
|          |                      |
|          |                      v
|          |            +----------------------+
|          |            | @bot-persona         |
|          |            | (Приложение "Чат-Бот")|
|          |            |----------------------|
|          |            | 1. Найти состояние   |
|          |            |    диалога           |
|          |            | 2. Выполнить шаг FSM |
|          |            | 3. Вернуть ответ     |
|          |            +----------------------+
|          |                      ^
|          |                      |
|          | (ответ: "Скажи вот это")|
|          |                      |
|          |<---------------------+
|          |                      |
| 4. Адаптер отправляет           |
|    полученный ответ клиенту     |
+---------------------------------+
```

Таким образом, **`@chat`** — это **хост-приложение**, отвечающее за инфраструктуру общения, а **`@bot-persona`** — это **плагин/зависимость**, которую `@chat` использует для реализации интеллектуального диалога.
