# Карта Контекстов (Context Map)

Этот документ описывает взаимосвязи между ключевыми Ограниченными Контекстами (Bounded Contexts) системы на языке бизнеса.

## Бизнес-метафора: Операционная Система и Приложения

Чтобы понять архитектуру, представим себе смартфон. У него есть операционная система, которая управляет базовыми функциями, и приложения, которые решают конкретные задачи пользователя.

---

### 1. Контекст: `@chat` — Сервис Чата (Headless Messenger)

**Роль в метафоре: Операционная система для обмена сообщениями.**

Этот контекст представляет собой полноценное, но "безголовое" (headless) приложение-мессенджер. Каждый его запущенный экземпляр настраивается на работу с **одним конкретным транспортным каналом** (например, один инстанс для Telegram, другой для Slack).

**Обязанности:**
- **Управление каналом**: Адаптер транспорта (driving adapter) подключается к API внешней платформы (например, Telegram) и слушает входящие сообщения.
- **Моделирование диалога**: Ядро контекста оперирует доменными сущностями: `Chat` (комната чата), `Persona` (участник) и `Message` (сообщение).
- **Оркестрация**: При получении сообщения, ядро `chat` выполняет базовые операции: сохраняет сообщение, создает пользователя (`Persona`) и чат (`Chat`), если их еще нет.
- **Делегирование логики ответа**: Чтобы сгенерировать осмысленный ответ, `@chat` обращается к внешнему сервису или библиотеке, передавая ему контекст диалога.

**На языке бизнеса**: это **платформа для создания чат-сервисов**. Она предоставляет всю необходимую инфраструктуру для общения в одном канале, позволяя подключать к ней различные бизнес-логики.

---

### 2. Контекст: `@bot-persona` — Движок Диалоговой Логики

**Роль в метафоре: Специализированное приложение "Чат-Бот".**

Этот контекст является подключаемым "мозгом". Он не может работать сам по себе, а предоставляет свои услуги другим системам, таким как `@chat`.

**Обязанности:**
- **Ведение состояния диалога**: Для каждого чата (`conversationId`) он хранит его текущее состояние в рамках сценария (FSM).
- **Обработка ввода**: Получив от `@chat` сообщение пользователя, он определяет, какому событию в сценарии оно соответствует.
- **Генерация ответа**: На основе сценария, он формирует следующий ответ, который нужно отправить пользователю, и возвращает его обратно в `@chat`.

**На языке бизнеса**: это **конструктор логики ботов**. Он позволяет бизнес-аналитикам и разработчикам проектировать сложные, интерактивные сценарии общения, которые затем могут быть исполнены на любой чат-платформе.

---

### 3. Контекст: `@nlu-engine` — Движок Обработки Естественного Языка

**Роль в метафоре: Специализированный сервис для понимания речи.**

Этот контекст предоставляет возможности для обработки естественного языка, определения намерений пользователей и извлечения сущностей из текста.

**Обязанности:**
- **Классификация намерений**: Определение типа запроса пользователя (вопрос, команда, заявка и т.д.)
- **Извлечение сущностей**: Выделение из текста ключевых параметров (имена, даты, числа, категории)
- **Семантический анализ**: Понимание контекста и смысла запроса пользователя
- **Генерация структурированного ответа**: Преобразование естественного языка в структурированные команды

**На языке бизнеса**: это **интеллектуальный интерпретатор**, который переводит человеческую речь на язык, понятный компьютеру.

---

### 4. Контекст: `@knowledge-base` — База Знаний и Поиск

**Роль в метафоре: Библиотека с информацией и система каталогизации.**

Этот контекст управляет коллекцией знаний (FAQ, документация, статьи) и обеспечивает эффективный поиск по ним.

**Обязанности:**
- **Хранение знаний**: Организация и хранение структурированной информации
- **Индексация контента**: Подготовка данных для быстрого поиска
- **Поиск и ранжирование**: Нахождение наиболее релевантных ответов на запросы пользователей
- **Управление категориями**: Классификация знаний по тематикам

**На языке бизнеса**: это **электронная библиотека** с системой каталогов, позволяющая быстро находить нужную информацию.

---

### 5. Контекст: `@booking-system` — Система Бронирования

**Роль в метафоре: Регистратура или система бронирования.**

Этаконтекст управляет процессами бронирования, расписанием и ресурсами.

**Обязанности:**
- **Управление расписанием**: Хранение и обновление графиков доступности
- **Бронирование ресурсов**: Резервирование времени, мест, услуг
- **Уведомления**: Отправка напоминаний и подтверждений
- **Управление отменами и переносами**: Обработка изменений в бронированиях

**На языке бизнеса**: это **регистратура**, которая ведет учет записей и напоминает о предстоящих встречах.

---

### 6. Контекст: `@user-profile` — Профиль Пользователя и Персонализация

**Роль в метафоре: Личная карточка и предпочтения пользователя.**

Этот контекст хранит информацию о пользователях и их предпочтениях для персонализации взаимодействия.

**Обязанности:**
- **Хранение профилей**: Управление данными пользователей
- **Персонализация**: Адаптация контента и взаимодействия под предпочтения пользователя
- **История взаимодействий**: Отслеживание предыдущих диалогов и действий
- **Управление настройками**: Хранение пользовательских предпочтений

**На языке бизнеса**: это **личное досье** каждого клиента, позволяющее персонализировать обслуживание.

---

### 7. Контекст: `@analytics` — Аналитика и Метрики

**Роль в метафоре: Служба отчетности и аналитики.**

Этот контекст собирает, обрабатывает и анализирует данные о взаимодействиях для получения инсайтов.

**Обязанности:**
- **Сбор метрик**: Агрегация данных о взаимодействиях
- **Анализ эффективности**: Оценка качества работы ботов
- **Генерация отчетов**: Создание аналитических отчетов
- **Мониторинг производительности**: Отслеживание работы системы

**На языке бизнеса**: это **отдел аналитики**, который помогает понять, как работают наши сервисы.

---

### 8. Контекст: `@bot-ui` — Визуальное Представление Интерфейса

**Роль в метафоре: Дизайнерский инструмент для создания интерфейсов.**

Этот контекст отвечает за визуальное представление диалоговых интерфейсов в чат-ботах. Он определяет, как будет выглядеть интерфейс бота и как пользователь будет с ним взаимодействовать.

**Обязанности:**
- **Библиотека компонентов интерфейса**: Единый источник правды о том, из каких элементов может состоять интерфейс бота (сообщения, кнопки, карточки и т.д.)
- **Компоновка интерфейсов**: Возможность создавать сложные экраны, комбинируя компоненты в различные layout'ы
- **Движок персонализации**: Механизм подстановки персональных данных пользователя в шаблоны интерфейса
- **Платформо-независимый рендеринг**: Подготовка универсального описания интерфейса, которое затем может быть адаптировано под любую платформу

**На языке бизнеса**: это **дизайнерский инструмент**, который позволяет создавать красивые и функциональные интерфейсы для чат-ботов, независимо от платформы.

---

## Схема взаимодействия

```
      Клиент (User)
           ^
           | (сообщение)
           v
+---------------------------------+
|  Инстанс @chat для Telegram     |
| (ОС для сообщений)              |
|---------------------------------|
| 1. Адаптер получает сообщение   |
| 2. Ядро создает/обновляет Chat, |
|    Persona, Message             |
| 3. Ядро ДЕЛЕГИРУЕТ получение    |
|    ответа движку @bot-persona   |
|          |                      |
|          +--------------------->|
|          |                      |
|          | (запрос: "Что ответить?")|
|          |                      |
|          |                      v
|          |            +----------------------+
|          |            | @bot-persona         |
|          |            | (Приложение "Чат-Бот")|
|          |            |----------------------|
|          |            | 1. Найти состояние   |
|          |            |    диалога           |
|          |            | 2. Выполнить шаг FSM |
|          |            | 3. Вернуть ответ     |
|          |            +----------------------+
|          |                      ^
|          |                      |
|          | (ответ: "Скажи вот это")|
|          |                      |
|          |<---------------------+
|          |                      |
| 4. Адаптер отправляет           |
|    полученный ответ клиенту     |
+---------------------------------+
```

Таким образом, **`@chat`** — это **хост-приложение**, отвечающее за инфраструктуру общения, а **`@bot-persona`** — это **плагин/зависимость**, которую `@chat` использует для реализации интеллектуального диалога.

Для более сложных ботов могут подключаться дополнительные контексты:

```
@bot-persona -----> @nlu-engine (для понимания естественного языка)
@bot-persona -----> @knowledge-base (для поиска ответов в FAQ)
@bot-persona -----> @booking-system (для управления бронированиями)
@bot-persona -----> @user-profile (для персонализации)
@bot-persona -----> @bot-ui (для визуального представления интерфейса)
@chat -----------> @analytics (для сбора метрик)
```